<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ncst.hospitaloutpatient.mapper.casefile.CaseMapper">

    <insert id="insertMedicalRecord" parameterType="com.ncst.hospitaloutpatient.model.entity.casefile.MedicalRecord" useGeneratedKeys="true" keyProperty="recordId">
        INSERT INTO medical_record
        (patient_no, registration_id, chief_complaint, present_history, physical_exam, diagnosis, treatment_plan, doctor_id, record_time)
        VALUES
            (#{patientNo}, #{registrationId}, #{chiefComplaint}, #{presentHistory}, #{physicalExam}, #{diagnosis}, #{treatmentPlan}, #{doctorId}, #{recordTime})
    </insert>

    <select id="selectRecordIdByRegistrationId" resultType="java.lang.Integer">
        SELECT record_id
        FROM medical_record
        WHERE registration_id = #{registrationId}
            LIMIT 1
    </select>

    <select id="selectCaseDetailById" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.CaseDetailDTO">
        SELECT
            patient_no AS patientNo,
            registration_id AS registrationId,
            chief_complaint AS chiefComplaint,
            present_history AS presentHistory,
            physical_exam AS physicalExam,
            diagnosis,
            treatment_plan AS treatmentPlan
        FROM medical_record
        WHERE record_id = #{caseId}
    </select>

    <update id="updateCase">
        UPDATE medical_record
        SET
            patient_no = #{dto.patientNo},
            registration_id = #{dto.registrationId},
            chief_complaint = #{dto.chiefComplaint},
            present_history = #{dto.presentHistory},
            physical_exam = #{dto.physicalExam},
            diagnosis = #{dto.diagnosis},
            treatment_plan = #{dto.treatmentPlan}
        WHERE
            record_id = #{caseId}
    </update>

    <insert id="insertMedicalItemApply" parameterType="com.ncst.hospitaloutpatient.model.entity.casefile.MedicalItemApply" useGeneratedKeys="true" keyProperty="applyId">
        INSERT INTO medical_item_apply
        (record_id, registration_id, item_id, apply_type, apply_purpose, apply_site, apply_time, status, unit, remark)
        VALUES
            (#{recordId}, #{registrationId}, #{itemId}, #{applyType}, #{applyPurpose}, #{applySite}, #{applyTime}, #{status}, #{unit}, #{remark})
    </insert>

    <select id="selectCaseApplyResults" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.CaseApplyResultDTO">
        SELECT
            apply_id AS applyId,
            item_id AS itemId,
            apply_type AS applyType,
            apply_purpose AS applyPurpose,
            apply_site AS applySite,
            apply_time AS applyTime,
            performer_id AS performerId,
            result_recorder_id AS resultRecorderId,
            perform_time AS performTime,
            result,
            status,
            unit,
            remark
        FROM medical_item_apply
        WHERE record_id = #{recordId}
        ORDER BY apply_time ASC
    </select>

    <insert id="insertPrescription" parameterType="com.ncst.hospitaloutpatient.model.entity.casefile.Prescription" useGeneratedKeys="true" keyProperty="prescriptionId">
        INSERT INTO prescription
        (record_id, registration_id, drug_id, dosage, quantity, prescribe_time, status, remark)
        VALUES
            (#{recordId}, #{registrationId}, #{drugId}, #{dosage}, #{quantity}, #{prescribeTime}, #{status}, #{remark})
    </insert>

    <!-- 1. 通过record_id查registration_id -->
    <select id="getRegistrationIdByRecordId" resultType="int">
        SELECT registration_id FROM medical_record WHERE record_id = #{recordId}
    </select>

    <!-- 2. 查挂号费，假设registration表里payable_amount字段为挂号费 -->
    <select id="selectRegistrationFee" resultType="java.math.BigDecimal">
        SELECT payable_amount FROM registration WHERE registration_id = #{registrationId}
    </select>

    <!-- 3. 查医疗项目费（join medical_service_item） -->
    <select id="selectMedicalItemFees" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.ItemFeeDTO">
        SELECT
            msi.item_name AS itemName,
            msi.price AS price,
            mia.unit AS unit,
            (msi.price * mia.unit) AS amount
        FROM medical_item_apply mia
                 JOIN medical_service_item msi ON mia.item_id = msi.item_id
        WHERE mia.record_id = #{recordId}
    </select>

    <!-- 4. 查处方药品费（join drug） -->
    <select id="selectPrescriptionFees" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.DrugFeeDTO">
        SELECT
            d.drug_name AS drugName,
            d.retail_price AS price,
            p.quantity AS quantity,
            (d.retail_price * p.quantity) AS amount
        FROM prescription p
                 JOIN drug d ON p.drug_id = d.drug_id
        WHERE p.record_id = #{recordId}
    </select>

    <update id="updateStatusToInitialConsultationDone">
        UPDATE patient_visit
        SET current_status = 'INITIAL_CONSULTATION_DONE',
            status_changed_at = NOW()
        WHERE registration_id = #{registrationId}
    </update>

    <update id="updateStatusToWaitingForProjectPayment">
        UPDATE patient_visit
        SET current_status = 'WAITING_FOR_PROJECT_PAYMENT',
            status_changed_at = NOW()
        WHERE registration_id = #{registrationId}
    </update>

    <!-- 查 registration_id -->
    <select id="selectRegistrationIdByRecordId" resultType="int">
        SELECT registration_id FROM medical_record WHERE record_id = #{recordId}
    </select>

    <!-- 更新 patient_visit 的 current_status -->
    <update id="updatePatientVisitStatusByRegistrationId">
        UPDATE patient_visit
        SET current_status = #{status}
        WHERE registration_id = #{registrationId}
    </update>

    <!-- 查询挂号患者列表 -->
    <select id="selectRegisteredPatientsByDoctor" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.DoctorPatientDTO">
        SELECT
            pv.registration_id AS registrationId,
            p.name,
            p.patient_no AS medicalNo,
            pv.current_status AS status,
            pv.visit_date AS registrationDate,
            mr.chief_complaint AS complaint
        FROM
            patient_visit pv
            JOIN patient p ON pv.patient_id = p.patient_id
            LEFT JOIN medical_record mr ON pv.registration_id = mr.registration_id
        WHERE
            pv.doctor_id = #{doctorId}
            <if test="keyword != null and keyword != ''">
                AND (
                    p.name LIKE CONCAT('%', #{keyword}, '%')
                    OR p.patient_no LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="statusList != null and statusList.size() > 0">
                AND pv.current_status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            AND pv.visit_date = #{visitDate}
        ORDER BY pv.visit_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计挂号患者总数 -->
    <select id="countRegisteredPatientsByDoctor" resultType="long">
        SELECT
            COUNT(*)
        FROM
            patient_visit pv
            JOIN patient p ON pv.patient_id = p.patient_id
        WHERE
            pv.doctor_id = #{doctorId}
            <if test="keyword != null and keyword != ''">
                AND (
                    p.name LIKE CONCAT('%', #{keyword}, '%')
                    OR p.patient_no LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="statusList != null and statusList.size() > 0">
                AND pv.current_status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            AND pv.visit_date = #{visitDate}
    </select>

    <select id="selectAllRegisteredPatientsByDoctor" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.DoctorPatientDTO">
        SELECT
            p.name,
            p.patient_no AS medicalNo,
            pv.current_status AS status,
            pv.visit_date AS registrationDate,
            mr.chief_complaint AS complaint
        FROM
            patient_visit pv
            JOIN patient p ON pv.patient_id = p.patient_id
            LEFT JOIN medical_record mr ON pv.registration_id = mr.registration_id
        WHERE
            pv.doctor_id = #{doctorId}
            <if test="statusList != null and statusList.size() > 0">
                AND pv.current_status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            AND pv.visit_date = #{visitDate}
        ORDER BY pv.visit_date DESC
    </select>

    <select id="selectPatientDetailByMedicalNo" resultType="com.ncst.hospitaloutpatient.model.dto.casefile.DoctorPatientDetailDTO">
        SELECT
            p.patient_id AS patientId,
            p.patient_no AS patientNo,
            p.name,
            p.gender,
            p.birthday,
            p.id_card AS idCard,
            p.address,
            p.patient_no AS medicalNo,
            pv.current_status AS status,
            pv.visit_date AS registrationDate,
            mr.chief_complaint AS complaint
        FROM
            patient_visit pv
            JOIN patient p ON pv.patient_id = p.patient_id
            LEFT JOIN medical_record mr ON pv.registration_id = mr.registration_id
        WHERE
            p.patient_no = #{medicalNo}
        ORDER BY pv.visit_date DESC
        LIMIT 1
    </select>

    <resultMap id="ClinicWorkspaceContextRawMap" type="com.ncst.hospitaloutpatient.model.dto.casefile.ClinicWorkspaceContextRawDTO">
        <result property="registrationId" column="registration_id"/>
        <result property="medicalNo" column="patient_no"/>
        <result property="patientName" column="name"/>
        <result property="patientGender" column="gender"/>
        <result property="birthDate" column="birthday"/>
        <result property="visitStatus" column="current_status"/>
        <result property="caseId" column="record_id"/>
    </resultMap>

    <select id="selectClinicContextByRegistrationId"
            resultMap="ClinicWorkspaceContextRawMap">
        SELECT
            pv.registration_id,
            p.patient_no,
            p.name,
            p.gender,
            p.birthday,
            pv.current_status,
            mr.record_id
        FROM patient_visit pv
                 JOIN patient p ON pv.patient_id = p.patient_id
                 LEFT JOIN medical_record mr ON pv.registration_id = mr.registration_id
        WHERE pv.registration_id = #{registrationId}
            LIMIT 1
    </select>

    <update id="updateVisitStatusToFinished">
        UPDATE patient_visit
        SET current_status = 'FINISHED'
        WHERE registration_id = #{registrationId}
    </update>

</mapper>