<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ncst.hospitaloutpatient.mapper.hr.EmployeeMapper">

    <select id="selectStaffDetailByFilter" resultType="com.ncst.hospitaloutpatient.model.dto.hr.StaffDetailResponse">
        SELECT
        s.staff_id,
        s.name,
        s.phone,
        s.id_card,
        s.department_id,
        d.department_name,
        d.type AS department_type,
        s.role_id,
        r.role_name,
        s.description,
        s.create_time,
        ext.is_expert,
        sa.status
        FROM staff s
        LEFT JOIN department d ON s.department_id = d.department_id
        LEFT JOIN staff_role r ON s.role_id = r.role_id
        LEFT JOIN staff_doctor_ext ext ON s.staff_id = ext.staff_id
        LEFT JOIN staff_account sa ON s.staff_id = sa.staff_id
        <where>
            <if test="keyword != null and keyword != ''">
                (s.name LIKE CONCAT('%', #{keyword}, '%') OR s.phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="departmentId != null">
                AND s.department_id = #{departmentId}
            </if>
            <if test="roleId != null">
                AND s.role_id = #{roleId}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortBy == 'name'">
                CONVERT(s.name USING gbk)
            </when>
            <when test="sortBy == 'createTime'">
                s.create_time
            </when>
            <otherwise>
                s.create_time
            </otherwise>
        </choose>
        <choose>
            <when test="order == 'asc'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countStaffDetailByFilter" resultType="long">
        SELECT COUNT(*)
        FROM staff s
        <where>
            <if test="keyword != null and keyword != ''">
                (s.name LIKE CONCAT('%', #{keyword}, '%') OR s.phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="departmentId != null">
                AND s.department_id = #{departmentId}
            </if>
            <if test="roleId != null">
                AND s.role_id = #{roleId}
            </if>
        </where>
    </select>

    <insert id="insertStaff" parameterType="com.ncst.hospitaloutpatient.model.entity.auth.StaffEntity"
            useGeneratedKeys="true" keyProperty="staffId">
        INSERT INTO staff (name, phone, id_card, department_id, description, role_id, create_time)
        VALUES (#{name}, #{phone}, #{idCard}, #{departmentId}, #{description}, #{roleId}, NOW())
    </insert>

    <insert id="insertStaffAccount">
        INSERT INTO staff_account
            (staff_id, account_name, password, status, create_time)
        VALUES
            (#{staffId}, #{accountName}, #{password}, 1, NOW())
    </insert>

    <insert id="insertStaffDoctorExt">
        INSERT INTO staff_doctor_ext
            (staff_id, is_expert)
        VALUES
            (#{staffId}, #{isExpert})
    </insert>

    <!-- 根据 roleId 获取角色名 -->
    <select id="getRoleNameById" resultType="string">
        SELECT role_name
        FROM staff_role
        WHERE role_id = #{roleId}
    </select>

    <!-- 获取账号前缀对应的最大后三位序号（例如 DOC011 -> 11） -->
    <select id="getMaxAccountSeqByPrefix" resultType="int">
        SELECT MAX(CAST(RIGHT(account_name, 3) AS UNSIGNED))
        FROM staff_account
        WHERE account_name LIKE CONCAT(#{prefix}, '%')
          AND account_name REGEXP CONCAT('^', #{prefix}, '[0-9]{3}$')
    </select>

    <!-- 更新 staff 表 -->
    <update id="updateStaff">
        UPDATE staff
        SET
            department_id = #{departmentId},
            role_id = #{roleId},
            name = #{name},
            phone = #{phone},
            id_card = #{idCard}
        WHERE staff_id = #{id}
    </update>

    <!-- 更新 staff_doctor_ext 表（只更新 is_expert 字段） -->
    <update id="updateDoctorExt">
        UPDATE staff_doctor_ext
        SET is_expert = #{isExpert}
        WHERE staff_id = #{id}
    </update>

    <update id="deleteEmployeeByStaffId">
        UPDATE staff_account
        SET status = 0
        WHERE staff_id = #{staffId}
    </update>

    <update id="restoreEmployeeByStaffId">
        UPDATE staff_account
        SET status = 1
        WHERE staff_id = #{staffId}
    </update>

    <select id="selectStaffDetailById" resultType="com.ncst.hospitaloutpatient.model.dto.hr.StaffDetailResponse">
        SELECT
            s.staff_id,
            s.name,
            s.phone,
            s.id_card,
            s.department_id,
            d.department_name,
            d.type AS department_type,
            s.role_id,
            r.role_name,
            s.description,
            s.create_time,
            ext.is_expert,
            sa.status
        FROM staff s
                 LEFT JOIN department d ON s.department_id = d.department_id
                 LEFT JOIN staff_role r ON s.role_id = r.role_id
                 LEFT JOIN staff_doctor_ext ext ON s.staff_id = ext.staff_id
                 LEFT JOIN staff_account sa ON s.staff_id = sa.staff_id
        WHERE s.staff_id = #{staffId}
    </select>

    <select id="existsStaffById" resultType="boolean">
        SELECT COUNT(1) > 0
        FROM staff
        WHERE staff_id = #{staffId}
    </select>

    <update id="updatePasswordByStaffId">
        UPDATE staff_account
        SET password = #{password}
        WHERE staff_id = #{staffId}
    </update>

    <select id="selectAllRoles" resultType="com.ncst.hospitaloutpatient.model.dto.hr.StaffRoleResponse">
        SELECT
            role_id   AS roleId,
            role_name AS roleName,
            description
        FROM staff_role
        ORDER BY role_id
    </select>

    <select id="getDepartmentType" resultType="string">
        SELECT type
        FROM department
        WHERE department_id = #{departmentId}
    </select>

</mapper>