<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ncst.hospitaloutpatient.mapper.medicalitem.DisposalMapper">

    <select id="getDepartmentIdByStaffId" resultType="int">
        SELECT department_id
        FROM staff
        WHERE staff_id = #{staffId}
            LIMIT 1
    </select>

    <select id="selectDisposalApplies" resultType="com.ncst.hospitaloutpatient.model.dto.medicalitem.ExamApplyDTO">
      SELECT
        mia.apply_id AS applyId,
        mr.record_id AS recordId,
        mr.registration_id AS registrationId,
        p.patient_no AS patientNo,
        p.name AS patientName,
        p.gender AS gender,
        msi.item_id AS itemId,
        msi.item_name AS itemName,
        mia.apply_purpose AS applyPurpose,
        mia.apply_site AS applySite,
        mia.unit AS unit,
        mia.remark AS remark,
        mia.status AS status,
        DATE_FORMAT(mia.apply_time, '%Y-%m-%d %H:%i:%s') AS applyTime
      FROM medical_item_apply mia
      JOIN medical_record mr ON mia.record_id = mr.record_id
      JOIN patient_visit pv ON mr.registration_id = pv.registration_id
      JOIN patient p ON pv.patient_id = p.patient_id
      JOIN medical_service_item msi ON mia.item_id = msi.item_id
      WHERE msi.department_id = #{departmentId}
        AND DATE(mia.apply_time) = #{today}
        AND mia.status = 'UNFINISHED'
        <if test="keyword != null and keyword != ''">
          AND (p.name LIKE CONCAT('%', #{keyword}, '%')
               OR msi.item_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
      ORDER BY
        <choose>
          <when test="sortBy == 'patientName'">p.name</when>
          <otherwise>mia.apply_time</otherwise>
        </choose>
        <choose>
          <when test="order != null and (order == 'asc' or order == 'ASC')">ASC</when>
          <otherwise>DESC</otherwise>
        </choose>
      LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countDisposalApplies" resultType="long">
      SELECT COUNT(1)
      FROM medical_item_apply mia
      JOIN medical_record mr ON mia.record_id = mr.record_id
      JOIN patient_visit pv ON mr.registration_id = pv.registration_id
      JOIN patient p ON pv.patient_id = p.patient_id
      JOIN medical_service_item msi ON mia.item_id = msi.item_id
      WHERE msi.department_id = #{departmentId}
        AND DATE(mia.apply_time) = #{today}
        AND mia.status = 'UNFINISHED'
        <if test="keyword != null and keyword != ''">
          AND (p.name LIKE CONCAT('%', #{keyword}, '%')
               OR msi.item_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <select id="getRegistrationIdByApplyId" resultType="int">
        SELECT registration_id
        FROM medical_item_apply
        WHERE apply_id = #{applyId}
    </select>

    <update id="cancelDisposalApply">
        UPDATE medical_item_apply
        SET status = 'CANCELLED'
        WHERE apply_id = #{applyId}
          AND status != 'CANCELLED'
    </update>

    <select id="getCurrentStatus" resultType="string">
        SELECT current_status
        FROM patient_visit
        WHERE registration_id = #{registrationId}
    </select>

    <insert id="insert" parameterType="com.ncst.hospitaloutpatient.model.entity.medicalItem.MedicalItemOperationLog">
        INSERT INTO medical_item_operation_log
        (apply_id, operator_id, operate_time, operate_type, item_id, item_name, item_type, patient_no, patient_name, remark)
        VALUES
            (#{applyId}, #{operatorId}, NOW(), #{operateType}, #{itemId}, #{itemName}, #{itemType}, #{patientNo}, #{patientName}, #{remark})
    </insert>

    <select id="getApplyInfoForLog" resultType="com.ncst.hospitaloutpatient.model.dto.medicalitem.ItemApplyInfoForLog">
        SELECT
            a.item_id,
            b.item_name,
            b.item_type,
            p.patient_no,
            p.name AS patient_name
        FROM medical_item_apply a
                 LEFT JOIN medical_service_item b ON a.item_id = b.item_id
                 LEFT JOIN registration r ON a.registration_id = r.registration_id
                 LEFT JOIN patient p ON r.patient_id = p.patient_id
        WHERE a.apply_id = #{applyId}
    </select>

    <update id="updateCurrentStatus">
        UPDATE patient_visit SET current_status = #{status} WHERE registration_id = #{registrationId}
    </update>


    <select id="getApplyStatusById" resultType="string">
        SELECT status FROM medical_item_apply WHERE apply_id = #{applyId}
    </select>

    <update id="updatePerformer">
        UPDATE medical_item_apply
        SET performer_id = #{performerId},
            perform_time = #{performTime}
        WHERE apply_id = #{applyId}
    </update>

    <update id="updateResultStatusAndRecorder">
        UPDATE medical_item_apply
        SET result = #{result},
            status = #{status},
            result_recorder_id = #{resultRecorderId}
        WHERE apply_id = #{applyId}
    </update>

    <insert id="insertOperationLog" parameterType="com.ncst.hospitaloutpatient.model.entity.medicalItem.MedicalItemOperationLog">
        INSERT INTO medical_item_operation_log
        (apply_id, operator_id, operate_time, operate_type, item_id, item_name, item_type, patient_no, patient_name, remark)
        VALUES
            (#{applyId}, #{operatorId}, NOW(), #{operateType}, #{itemId}, #{itemName}, #{itemType}, #{patientNo}, #{patientName}, #{remark})
    </insert>

    <update id="updatePatientVisitStatus">
        UPDATE patient_visit
        SET current_status = #{status}
        WHERE registration_id = #{registrationId}
    </update>

    <select id="countUnfinishedApplies" resultType="int">
        SELECT COUNT(1)
        FROM medical_item_apply
        WHERE registration_id = #{registrationId} AND status NOT IN ('FINISHED', 'CANCELLED')
    </select>

    <select id="listDepartmentsByType" resultType="com.ncst.hospitaloutpatient.model.dto.medicalitem.DepartmentSimpleDTO">
        SELECT department_id AS departmentId,
               department_name AS departmentName,
               type
        FROM department
        WHERE type = #{type}
    </select>

    <select id="listStaffsByDepartmentId" resultType="com.ncst.hospitaloutpatient.model.dto.medicalitem.StaffSimpleDTO">
        SELECT
            staff_id AS staffId,
            name,
            phone,
            id_card AS idCard,
            department_id AS departmentId,
            description,
            role_id AS roleId
        FROM staff
        WHERE department_id = #{departmentId}
    </select>

    <select id="listOperateLogs" resultType="com.ncst.hospitaloutpatient.model.dto.medicalitem.MedicalItemOperateLogDTO">
      SELECT
        l.log_id AS logId,
        l.apply_id AS applyId,
        l.operator_id AS operatorId,
        s.name AS operatorName,
        l.operate_type AS operateType,
        l.item_id AS itemId,
        l.item_name AS itemName,
        l.item_type AS itemType,
        l.patient_no AS patientNo,
        l.patient_name AS patientName,
        l.remark AS remark,
        l.operate_time AS operateTime
      FROM medical_item_operation_log l
      LEFT JOIN staff s ON s.staff_id = l.operator_id
      WHERE (#{keyword} IS NULL OR l.item_name LIKE CONCAT('%', #{keyword}, '%') OR l.patient_name LIKE CONCAT('%', #{keyword}, '%'))
        AND (#{operateType} IS NULL OR l.operate_type = #{operateType})
        AND (#{operatorId} IS NULL OR l.operator_id = #{operatorId})
      ORDER BY
        CASE WHEN #{sortBy} = 'operateTime' THEN l.operate_time END,
        CASE WHEN #{sortBy} = 'itemName' THEN l.item_name END,
        l.operate_time
        ${order}
      LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countOperateLogs" resultType="long">
        SELECT COUNT(1) FROM medical_item_operation_log
        <where>
            item_type = 'DISPOSAL'
            <if test="operatorId != null">
                AND operator_id = #{operatorId}
            </if>
            <if test="operateType != null and operateType != ''">
                AND operate_type = #{operateType}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (patient_name LIKE CONCAT('%', #{keyword}, '%')
                OR item_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

</mapper>